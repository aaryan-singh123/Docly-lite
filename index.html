<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Docly - Professional Clinic Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] } } }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { transition: background-color 0.3s; }
        .glow-text { text-shadow: 0 0 20px rgba(56, 189, 248, 0.6); }
        .dark input, .dark select, .dark textarea { background-color: #1e293b !important; color: white !important; border-color: #334155 !important; }
        input, select, textarea { background-color: #f8fafc !important; color: #0f172a !important; }
        
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 selection:bg-blue-200 dark:selection:bg-blue-900">

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="fixed inset-0 z-[100] bg-blue-600 dark:bg-blue-900 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 p-6 md:p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="inline-flex p-4 rounded-3xl bg-blue-50 dark:bg-blue-800/20 mb-4">
                    <i data-lucide="stethoscope" class="text-blue-600 w-10 h-10 md:w-12 md:h-12"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">Docly</h1>
                <p class="text-slate-400 text-sm font-medium mt-2">Clinic Management System</p>
            </div>
            <form id="loginForm" class="space-y-4 md:space-y-6">
                <input type="text" id="username" required class="w-full px-5 py-4 rounded-2xl border outline-none transition focus:ring-2 focus:ring-blue-500" placeholder="Username (recdemo/docdemo/admdemo)">
                <input type="password" id="password" required class="w-full px-5 py-4 rounded-2xl border outline-none transition focus:ring-2 focus:ring-blue-500" placeholder="Password (123)">
                <button type="submit" class="w-full py-4 md:py-5 bg-blue-600 text-white rounded-2xl font-bold text-lg shadow-xl hover:bg-blue-700 transition active:scale-95">Sign In</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP WRAPPER -->
    <div id="app" class="hidden">
        <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200 dark:border-slate-800 px-4 md:px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg"><i data-lucide="activity"></i></div>
                <span class="text-xl md:text-2xl font-black tracking-tighter">DOCLY</span>
            </div>
            <div class="flex items-center gap-3 md:gap-5">
                <div class="text-right">
                    <p id="userRoleDisplay" class="text-sm font-extrabold capitalize leading-none hidden md:block"></p>
                    <span id="syncStatus" class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest flex items-center gap-1">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> LIVE
                    </span>
                </div>
                <button onclick="logout()" class="p-2 md:p-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-2xl hover:text-red-600 transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </nav>

        <!-- RECEPTION SECTION -->
        <main id="receptionSection" class="hidden p-4 md:p-8 max-w-[1500px] mx-auto w-full">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 xl:col-span-4">
                    <div class="bg-white dark:bg-slate-900 p-6 md:p-8 rounded-[2rem] shadow-sm border border-slate-200 dark:border-slate-800">
                        <h2 class="text-xl md:text-2xl font-extrabold mb-6 flex items-center gap-3 text-blue-600"><i data-lucide="user-plus"></i> Patient Entry</h2>
                        <form id="patientForm" class="space-y-4">
                            <input type="text" id="pName" placeholder="Full Name" required class="w-full px-5 py-4 border rounded-2xl outline-none focus:border-blue-500">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="pAge" placeholder="Age" required class="w-full px-5 py-4 border rounded-2xl outline-none focus:border-blue-500">
                                <select id="pGender" class="w-full px-5 py-4 border rounded-2xl outline-none font-bold focus:border-blue-500"><option>Male</option><option>Female</option><option>Other</option></select>
                            </div>
                            <input type="tel" id="pPhone" placeholder="Phone Number" required class="w-full px-5 py-4 border rounded-2xl outline-none focus:border-blue-500">
                            <input type="text" id="pDisease" placeholder="Primary Concern / Disease" required class="w-full px-5 py-4 border rounded-2xl outline-none focus:border-blue-500">
                            <textarea id="pAddress" placeholder="Full Address" class="w-full px-5 py-4 border rounded-2xl outline-none h-24 resize-none focus:border-blue-500"></textarea>
                            <button type="submit" id="regBtn" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-bold shadow-xl hover:bg-blue-700 transition transform active:scale-95">Register Patient</button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white dark:bg-slate-900 p-4 rounded-[2rem] border dark:border-slate-800 shadow-sm"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Waiting</p><p id="recWaiting" class="text-3xl font-black text-orange-500 mt-2">0</p></div>
                        <div class="bg-white dark:bg-slate-900 p-4 rounded-[2rem] border dark:border-slate-800 shadow-sm"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Completed</p><p id="recDone" class="text-3xl font-black text-emerald-500 mt-2">0</p></div>
                        <div class="bg-white dark:bg-slate-900 p-4 rounded-[2rem] border dark:border-slate-800 shadow-sm"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total</p><p id="recTotal" class="text-3xl font-black mt-2">0</p></div>
                        <div class="bg-slate-900 p-4 rounded-[2rem] shadow-xl col-span-2 md:col-span-1 border-2 border-blue-500/30"><p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">CALLING</p><div id="recNowCalling" class="text-4xl font-black text-blue-400 glow-text">--</div></div>
                    </div>
                    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] border dark:border-slate-800 overflow-hidden shadow-sm">
                        <div class="px-6 py-5 border-b dark:border-slate-800 font-extrabold flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30">
                            <span>Live Queue Management</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[600px]">
                                <thead class="text-[10px] font-black uppercase text-slate-400 bg-slate-50 dark:bg-slate-800/50">
                                    <tr><th class="px-6 py-4">Token</th><th class="px-6 py-4">Patient Info</th><th class="px-6 py-4">Disease</th><th class="px-6 py-4">Status</th><th class="px-6 py-4 text-right">Action</th></tr>
                                </thead>
                                <tbody id="recTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- DOCTOR SECTION -->
        <main id="doctorSection" class="hidden p-4 md:p-8 max-w-5xl mx-auto w-full space-y-6">
            <div class="bg-slate-900 p-8 md:p-12 rounded-[3rem] text-center shadow-2xl relative border border-slate-800">
                <span class="px-4 py-1.5 bg-blue-500/10 rounded-full border border-blue-500/20 text-blue-400 text-[10px] font-black tracking-widest uppercase mb-4 inline-block">On-Going Consultation</span>
                <h2 id="docTokenDisplay" class="text-7xl md:text-[10rem] font-black leading-none text-white glow-text tracking-tighter my-4">--</h2>
                <div id="docPatientDetails" class="space-y-2 mb-8">
                    <div id="docPatientInfo" class="text-2xl md:text-4xl font-bold text-white tracking-tight">System Ready</div>
                    <div id="docPatientDisease" class="text-lg text-blue-400 font-bold uppercase tracking-wider">Please call a patient</div>
                </div>

                <!-- Doctor Payment Form -->
                <div id="docPaymentForm" class="hidden max-w-md mx-auto bg-slate-800/50 p-6 rounded-3xl border border-slate-700 space-y-4 mb-8">
                    <h4 class="text-white font-bold text-left">Complete Consultation & Fees</h4>
                    <input type="number" id="docFees" placeholder="Enter Fees Amount" class="w-full px-5 py-4 rounded-xl border-none outline-none focus:ring-2 focus:ring-emerald-500 !bg-slate-700 !text-white" />
                    <select id="docPayMethod" onchange="toggleDocUPI()" class="w-full px-5 py-4 rounded-xl border-none outline-none !bg-slate-700 !text-white font-bold">
                        <option value="Cash">Cash Payment</option>
                        <option value="UPI">UPI / Online</option>
                    </select>
                    <input type="text" id="docTxnId" placeholder="Transaction ID" class="hidden w-full px-5 py-4 rounded-xl border-none outline-none !bg-slate-700 !text-white" />
                    <button onclick="submitConsultation()" class="w-full py-4 bg-emerald-500 text-slate-900 rounded-xl font-black text-lg hover:bg-emerald-400 transition">COMPLETE & SUBMIT</button>
                </div>

                <button onclick="nextPatient()" id="nextBtn" class="w-full md:w-auto px-12 py-6 bg-blue-600 text-white rounded-[2rem] font-black text-2xl shadow-xl hover:bg-blue-500 transition transform hover:scale-105 active:scale-95 flex items-center justify-center gap-4 mx-auto">
                    CALL NEXT PATIENT <i data-lucide="arrow-right-circle"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border dark:border-slate-800 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Wait List</p>
                    <p id="statPendingToday" class="text-4xl font-black text-orange-500 mt-2">0</p>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border dark:border-slate-800 text-center">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Completed Today</p>
                    <p id="statDoneToday" class="text-4xl font-black text-emerald-500 mt-2">0</p>
                </div>
                <button onclick="toggleTheme()" class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border dark:border-slate-800 flex items-center justify-center gap-3 hover:bg-slate-50 transition">
                    <i data-lucide="moon"></i> <span class="font-bold">Dark Mode</span>
                </button>
            </div>
        </main>

        <!-- ADMIN SECTION -->
        <main id="adminSection" class="hidden p-4 md:p-8 max-w-7xl mx-auto w-full space-y-8">
            <div class="flex flex-col md:flex-row justify-between items-end gap-6 bg-white dark:bg-slate-900 p-8 rounded-[3rem] border dark:border-slate-800">
                <div class="w-full md:w-auto">
                    <h2 class="text-3xl font-black tracking-tight mb-4">Admin Control Center</h2>
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[150px]"><label class="text-[10px] font-black text-slate-400 uppercase block mb-1">From</label><input type="date" id="admFrom" class="w-full h-12 px-4 rounded-xl border font-bold"></div>
                        <div class="flex-1 min-w-[150px]"><label class="text-[10px] font-black text-slate-400 uppercase block mb-1">To</label><input type="date" id="admTo" class="w-full h-12 px-4 rounded-xl border font-bold"></div>
                        <button onclick="fetchHistory()" class="h-12 mt-auto px-8 bg-blue-600 text-white rounded-xl font-bold">Filter Data</button>
                    </div>
                </div>
                <div class="flex gap-3 w-full md:w-auto">
                    <button onclick="downloadHistory()" class="flex-1 h-16 px-6 bg-emerald-600 text-white rounded-2xl font-black text-sm flex items-center justify-center gap-2"><i data-lucide="download"></i> CSV</button>
                    <button onclick="securePurge()" class="flex-1 h-16 px-6 bg-red-100 text-red-600 rounded-2xl font-black text-sm flex items-center justify-center gap-2 border border-red-200"><i data-lucide="trash-2"></i> Purge</button>
                </div>
            </div>

            <!-- Collection Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-600 p-8 rounded-[3rem] text-white shadow-xl shadow-blue-500/20">
                    <p class="text-xs font-bold opacity-80 uppercase tracking-widest">Total Collection</p>
                    <h3 id="collTotal" class="text-4xl md:text-5xl font-black mt-2">₹0.00</h3>
                </div>
                <div class="bg-white dark:bg-slate-900 p-8 rounded-[3rem] border dark:border-slate-800 shadow-sm">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Cash Collection</p>
                    <h3 id="collCash" class="text-4xl font-black text-emerald-500 mt-2">₹0.00</h3>
                </div>
                <div class="bg-white dark:bg-slate-900 p-8 rounded-[3rem] border dark:border-slate-800 shadow-sm">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">UPI Collection</p>
                    <h3 id="collUPI" class="text-4xl font-black text-blue-500 mt-2">₹0.00</h3>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 rounded-[3rem] border dark:border-slate-800 overflow-hidden shadow-sm">
                <div class="px-8 py-5 border-b dark:border-slate-800 flex justify-between bg-slate-50 dark:bg-slate-800/50">
                    <span class="font-black">Patient Log & Financials</span>
                    <span id="histCount" class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-bold">0 records</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[800px]">
                        <thead class="text-[10px] font-black uppercase text-slate-400 bg-slate-50 dark:bg-slate-800/50">
                            <tr>
                                <th class="px-8 py-4">Date</th><th class="px-8 py-4">Token</th><th class="px-8 py-4">Patient</th><th class="px-8 py-4">Disease</th>
                                <th class="px-8 py-4">Payment</th><th class="px-8 py-4">Fees</th><th class="px-8 py-4">Status</th>
                            </tr>
                        </thead>
                        <tbody id="histTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = "https://cnpytnxklswutujeitju.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNucHl0bnhrbHN3dXR1amVpdGp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDI2NjMsImV4cCI6MjA4NjkxODY2M30.jOb1bEOMLVZc-wZ6MsOzJ4eY7K7aByPabC-8I2wDlUo";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let session = JSON.parse(localStorage.getItem('docly_session')) || null;
        let realtimeSubscription;

        window.onload = () => {
            if (localStorage.getItem('docly_theme') === 'dark') document.documentElement.classList.add('dark');
            const today = new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD local format
            document.getElementById('admFrom').value = today;
            document.getElementById('admTo').value = today;
            
            if (session) initApp();
            lucide.createIcons();
        };

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('docly_theme', isDark ? 'dark' : 'light');
            lucide.createIcons();
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            let role = (u === 'recdemo' && p === '123') ? 'reception' : 
                       (u === 'docdemo' && p === '123') ? 'doctor' : 
                       (u === 'admdemo' && p === '123') ? 'admin' : '';
            if (role) {
                session = { role, name: u };
                localStorage.setItem('docly_session', JSON.stringify(session));
                initApp();
            } else alert('Access Denied: Invalid Credentials');
        });

        function logout() { 
            if (realtimeSubscription) _supabase.removeChannel(realtimeSubscription);
            localStorage.removeItem('docly_session'); 
            location.reload(); 
        }

        async function initApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('userRoleDisplay').innerText = session.role;
            
            const sections = ['receptionSection', 'doctorSection', 'adminSection'];
            sections.forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(`${session.role}Section`).classList.remove('hidden');

            await fetchData();
            setupRealtime();
        }

        function setupRealtime() {
            if (realtimeSubscription) _supabase.removeChannel(realtimeSubscription);
            realtimeSubscription = _supabase.channel('public:patients')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'patients' }, () => {
                    fetchData();
                })
                .subscribe();
        }

        async function fetchData() {
            const { data, error } = await _supabase.from('patients').select('*').order('created_at', { ascending: false });
            if (!error) {
                allData = data || [];
                renderUI();
            } else {
                console.error("Fetch error:", error);
            }
        }

        function renderUI() {
            if (session.role === 'reception') renderReception();
            if (session.role === 'doctor') renderDoctor();
            if (session.role === 'admin') { renderAdmin(); fetchHistory(); }
        }

        // --- RECEPTION LOGIC ---
        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('regBtn');
            btn.innerText = "Registering..."; btn.disabled = true;

            try {
                const today = new Date().toLocaleDateString('en-CA');
                // Get current count for token
                const { data: countData } = await _supabase.from('patients').select('token').eq('visit_date', today);
                const newToken = (countData?.length || 0) + 1;

                const { error } = await _supabase.from('patients').insert([{
                    token: newToken, 
                    name: document.getElementById('pName').value, 
                    age: document.getElementById('pAge').value,
                    gender: document.getElementById('pGender').value, 
                    phone: document.getElementById('pPhone').value,
                    disease: document.getElementById('pDisease').value,
                    address: document.getElementById('pAddress').value, 
                    visit_date: today, 
                    status: 'waiting'
                }]);

                if(error) throw error;

                e.target.reset();
                await fetchData(); // Force refresh
                alert(`Registered Successfully! Token: #${newToken}`);
            } catch (err) { 
                alert("Error: " + err.message); 
            } finally { 
                btn.innerText = "Register Patient"; btn.disabled = false; 
            }
        });

        function renderReception() {
            const today = new Date().toLocaleDateString('en-CA');
            // Filter only today's patients for the queue display
            const list = allData.filter(p => p.visit_date === today);
            
            document.getElementById('recWaiting').innerText = list.filter(p => p.status === 'waiting').length;
            document.getElementById('recDone').innerText = list.filter(p => p.status === 'completed').length;
            document.getElementById('recTotal').innerText = list.length;
            
            const now = list.find(p => p.status === 'calling');
            document.getElementById('recNowCalling').innerText = now ? `#${now.token}` : "--";

            // Sorting for table: newest first
            document.getElementById('recTableBody').innerHTML = list.map(p => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <td class="px-6 py-5 font-black text-2xl tracking-tighter">#${p.token}</td>
                    <td class="px-6 py-5">
                        <div class="font-extrabold">${p.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">${p.age}Y • ${p.gender}</div>
                    </td>
                    <td class="px-6 py-5 text-sm font-bold text-slate-500">${p.disease || 'General Checkup'}</td>
                    <td class="px-6 py-5">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase 
                            ${p.status === 'waiting' ? 'bg-orange-100 text-orange-600' : 
                              p.status === 'calling' ? 'bg-blue-600 text-white animate-pulse' : 
                              'bg-emerald-100 text-emerald-600'}">
                            ${p.status}
                        </span>
                    </td>
                    <td class="px-6 py-5 text-right">
                        <button onclick="deletePatient('${p.id}')" class="text-slate-300 hover:text-red-500 transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function deletePatient(id) {
            if (confirm('Delete patient record?')) {
                await _supabase.from('patients').delete().eq('id', id);
                await fetchData();
            }
        }

        // --- DOCTOR LOGIC ---
        function toggleDocUPI() {
            const isUPI = document.getElementById('docPayMethod').value === 'UPI';
            document.getElementById('docTxnId').classList.toggle('hidden', !isUPI);
        }

        async function nextPatient() {
            const today = new Date().toLocaleDateString('en-CA');
            // Get patients in waiting status, sorted by token ascending
            const waiting = allData.filter(p => p.visit_date === today && p.status === 'waiting').sort((a,b) => a.token - b.token);
            
            if (waiting.length === 0) return alert("No more patients in queue!");
            
            const next = waiting[0];
            await _supabase.from('patients').update({ status: 'calling' }).eq('id', next.id);
            await fetchData();
        }

        async function submitConsultation() {
            const fees = document.getElementById('docFees').value;
            const method = document.getElementById('docPayMethod').value;
            const txn = document.getElementById('docTxnId').value || 'N/A';
            
            if (!fees) return alert("Please enter Fees amount.");

            const active = allData.find(p => p.status === 'calling');
            if (!active) return;

            const { error } = await _supabase.from('patients').update({
                status: 'completed',
                fees: parseFloat(fees),
                payment_method: method,
                transaction_id: txn
            }).eq('id', active.id);

            if (!error) {
                alert("Consultation Completed & Data Submitted!");
                document.getElementById('docFees').value = '';
                document.getElementById('docTxnId').value = '';
                await fetchData();
            }
        }

        function renderDoctor() {
            const today = new Date().toLocaleDateString('en-CA');
            const list = allData.filter(p => p.visit_date === today);
            const active = list.find(p => p.status === 'calling');
            
            const info = document.getElementById('docPatientInfo');
            const disease = document.getElementById('docPatientDisease');
            const token = document.getElementById('docTokenDisplay');
            const form = document.getElementById('docPaymentForm');
            const callBtn = document.getElementById('nextBtn');

            if (active) {
                token.innerText = `#${active.token}`;
                info.innerText = `${active.name} (${active.age}y / ${active.gender})`;
                disease.innerText = active.disease || "No disease specified";
                form.classList.remove('hidden');
                callBtn.classList.add('hidden');
            } else {
                token.innerText = "--";
                info.innerText = "System Ready";
                disease.innerText = "Please call a patient";
                form.classList.add('hidden');
                callBtn.classList.remove('hidden');
            }

            document.getElementById('statPendingToday').innerText = list.filter(p => p.status === 'waiting').length;
            document.getElementById('statDoneToday').innerText = list.filter(p => p.status === 'completed').length;
        }

        // --- ADMIN LOGIC ---
        function renderAdmin() {}

        async function fetchHistory() {
            const from = document.getElementById('admFrom').value;
            const to = document.getElementById('admTo').value;
            
            let filtered = allData;
            if (from && to) {
                filtered = allData.filter(p => p.visit_date >= from && p.visit_date <= to);
            }

            const total = filtered.reduce((acc, p) => acc + (p.fees || 0), 0);
            const cash = filtered.filter(p => p.payment_method === 'Cash').reduce((acc, p) => acc + (p.fees || 0), 0);
            const upi = filtered.filter(p => p.payment_method === 'UPI').reduce((acc, p) => acc + (p.fees || 0), 0);

            document.getElementById('collTotal').innerText = `₹${total.toLocaleString()}`;
            document.getElementById('collCash').innerText = `₹${cash.toLocaleString()}`;
            document.getElementById('collUPI').innerText = `₹${upi.toLocaleString()}`;
            document.getElementById('histCount').innerText = `${filtered.length} records`;

            document.getElementById('histTableBody').innerHTML = filtered.map(p => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <td class="px-8 py-4 text-xs font-bold text-slate-400 whitespace-nowrap">${p.visit_date}</td>
                    <td class="px-8 py-4 font-black">#${p.token}</td>
                    <td class="px-8 py-4">
                        <div class="font-bold">${p.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold">${p.age}Y • ${p.gender}</div>
                    </td>
                    <td class="px-8 py-4 text-sm font-medium text-slate-500">${p.disease || '-'}</td>
                    <td class="px-8 py-4">
                        <div class="text-[10px] font-black uppercase ${p.payment_method === 'UPI' ? 'text-blue-500' : 'text-emerald-500'}">${p.payment_method || '-'}</div>
                        <div class="text-[9px] text-slate-400 truncate max-w-[100px]">${p.transaction_id || ''}</div>
                    </td>
                    <td class="px-8 py-4 font-black">₹${p.fees || 0}</td>
                    <td class="px-8 py-4">
                        <span class="text-[9px] font-black uppercase px-2 py-0.5 rounded-full ${p.status === 'completed' ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}">${p.status}</span>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function downloadHistory() {
            const { data, error } = await _supabase.from('patients').select('*').csv();
            if (error) return alert('Export Failed');
            const blob = new Blob([data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Docly_Reports_${new Date().toISOString().slice(0,10)}.csv`; a.click();
        }

        async function securePurge() {
            const pwd = prompt("Enter Admin Password to PURGE ALL RECORDS:");
            if (pwd === "123") {
                if (confirm("DANGER: Delete ALL data permanently?")) {
                    await _supabase.from('patients').delete().neq('token', -1);
                    await fetchData();
                }
            } else alert("Invalid Password.");
        }
    </script>
</body>
</html>
