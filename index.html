<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Docly - Professional Clinic Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] } } }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { transition: background-color 0.3s; }
        .glow-text { text-shadow: 0 0 20px rgba(56, 189, 248, 0.6); }
        .dark input, .dark select, .dark textarea { background-color: #1e293b !important; color: white !important; border-color: #334155 !important; }
        input, select, textarea { background-color: #f8fafc !important; color: #0f172a !important; }
        .report-overlay { display: none; }
        .report-overlay.active { display: block; }
        
        /* Mobile scrollbar fix */
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 selection:bg-blue-200 dark:selection:bg-blue-900">

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="fixed inset-0 z-[100] bg-blue-600 dark:bg-blue-900 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-slate-900 p-6 md:p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="inline-flex p-4 rounded-3xl bg-blue-50 dark:bg-blue-800/20 mb-4">
                    <i data-lucide="stethoscope" class="text-blue-600 w-10 h-10 md:w-12 md:h-12"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900 dark:text-white">Docly</h1>
            </div>
            <form id="loginForm" class="space-y-4 md:space-y-6">
                <input type="text" id="username" required class="w-full px-5 py-4 rounded-2xl border outline-none transition focus:ring-2 focus:ring-blue-500" placeholder="Username (recdemo / docdemo)">
                <input type="password" id="password" required class="w-full px-5 py-4 rounded-2xl border outline-none transition focus:ring-2 focus:ring-blue-500" placeholder="Password (123)">
                <button type="submit" class="w-full py-4 md:py-5 bg-blue-600 text-white rounded-2xl font-bold text-lg shadow-xl hover:bg-blue-700 transition active:scale-95">Sign In</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP WRAPPER -->
    <div id="app" class="hidden">
        <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200 dark:border-slate-800 px-4 md:px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg"><i data-lucide="activity"></i></div>
                <span class="text-xl md:text-2xl font-black tracking-tighter">DOCLY-L</span>
            </div>
            <div class="flex items-center gap-3 md:gap-5">
                <div class="text-right">
                    <p id="userRoleDisplay" class="text-sm font-extrabold capitalize leading-none hidden md:block"></p>
                    <span id="syncStatus" class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest flex items-center gap-1">
                        <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> LIVE
                    </span>
                </div>
                <button onclick="logout()" class="p-2 md:p-3 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 rounded-2xl hover:text-red-600 transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </nav>

        <!-- RECEPTION SECTION -->
        <main id="receptionSection" class="hidden p-4 md:p-8 max-w-[1500px] mx-auto w-full">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Registration Form -->
                <div class="lg:col-span-4 xl:col-span-4">
                    <div class="bg-white dark:bg-slate-900 p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] shadow-sm border border-slate-200 dark:border-slate-800">
                        <h2 class="text-xl md:text-2xl font-extrabold mb-6 md:mb-8 flex items-center gap-3"><i data-lucide="user-plus" class="text-blue-600"></i> Register Patient</h2>
                        <form id="patientForm" class="space-y-4">
                            <input type="text" id="pName" placeholder="Full Name" required class="w-full px-5 py-4 border rounded-2xl outline-none focus:border-blue-500">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="pAge" placeholder="Age" required class="w-full px-5 py-4 border rounded-2xl outline-none focus:border-blue-500">
                                <select id="pGender" class="w-full px-5 py-4 border rounded-2xl outline-none font-bold focus:border-blue-500"><option>Male</option><option>Female</option></select>
                            </div>
                            <input type="tel" id="pPhone" placeholder="Phone Number" required class="w-full px-5 py-4 border rounded-2xl outline-none focus:border-blue-500">
                            <textarea id="pAddress" placeholder="Address" class="w-full px-5 py-4 border rounded-2xl outline-none h-24 resize-none focus:border-blue-500"></textarea>
                            <div class="p-5 bg-blue-50 dark:bg-blue-900/20 rounded-3xl border border-blue-100 dark:border-blue-800">
                                <select id="pPayment" onchange="toggleUPI()" class="w-full px-4 py-3 rounded-xl font-bold text-blue-600 bg-white dark:bg-slate-800 mb-2 border">
                                    <option value="Cash">Cash</option><option value="UPI">UPI / Online</option>
                                </select>
                                <input type="text" id="pTransaction" placeholder="Transaction ID" class="hidden w-full px-4 py-3 bg-white dark:bg-slate-800 rounded-xl border border-blue-200 text-sm">
                            </div>
                            <button type="submit" id="regBtn" class="w-full py-5 bg-blue-600 text-white rounded-[1.5rem] font-bold shadow-xl hover:bg-blue-700 transition transform active:scale-95">Register Now</button>
                        </form>
                    </div>
                </div>

                <!-- Dashboard & Queue -->
                <div class="lg:col-span-8 xl:col-span-8 space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 text-center">
                        <div class="bg-white dark:bg-slate-900 p-4 md:p-6 rounded-[2rem] border dark:border-slate-800"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Waiting</p><p id="recWaiting" class="text-3xl md:text-4xl font-black text-orange-500 mt-2">0</p></div>
                        <div class="bg-white dark:bg-slate-900 p-4 md:p-6 rounded-[2rem] border dark:border-slate-800"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Completed</p><p id="recDone" class="text-3xl md:text-4xl font-black text-emerald-500 mt-2">0</p></div>
                        <div class="bg-white dark:bg-slate-900 p-4 md:p-6 rounded-[2rem] border dark:border-slate-800"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest text-blue-500">Total Today</p><p id="recTotal" class="text-3xl md:text-4xl font-black mt-2">0</p></div>
                        <div class="bg-slate-900 p-4 md:p-6 rounded-[2rem] border-4 border-slate-800 shadow-xl flex flex-col justify-center items-center col-span-2 md:col-span-1">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">NOW CALLING</span>
                            <div id="recNowCalling" class="text-4xl md:text-5xl font-black text-blue-400 glow-text tracking-tighter">--</div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] border dark:border-slate-800 overflow-hidden shadow-sm">
                        <div class="px-6 md:px-8 py-5 border-b dark:border-slate-800 font-extrabold flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30">
                            <span>Today's Live Queue</span>
                            <button onclick="fetchData()" class="flex items-center gap-2 text-xs bg-white dark:bg-slate-800 border px-3 py-1.5 rounded-lg font-bold hover:bg-slate-50 transition">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync
                            </button>
                        </div>
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-left min-w-[600px]">
                                <thead class="text-[10px] font-black uppercase text-slate-400 bg-slate-50 dark:bg-slate-800/50">
                                    <tr><th class="px-6 md:px-8 py-4">Token</th><th class="px-6 md:px-8 py-4">Patient Info</th><th class="px-6 md:px-8 py-4">Status</th><th class="px-6 md:px-8 py-4 text-right">Action</th></tr>
                                </thead>
                                <tbody id="recTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- DOCTOR SECTION -->
        <main id="doctorSection" class="hidden p-4 md:p-8 max-w-5xl mx-auto w-full space-y-8">
            <div class="bg-slate-900 p-6 md:p-16 rounded-[2.5rem] md:rounded-[4rem] text-center shadow-2xl relative">
                <span class="px-4 py-1.5 bg-blue-500/10 rounded-full border border-blue-500/20 text-blue-400 text-[10px] md:text-xs font-black tracking-widest uppercase inline-block mb-4">Patient Consultation Room</span>
                <h2 id="docTokenDisplay" class="text-6xl md:text-9xl lg:text-[12rem] font-black leading-none text-white glow-text tracking-tighter my-4 md:my-8 transition-all">--</h2>
                <div id="docPatientInfo" class="text-xl md:text-3xl font-bold text-slate-400 mb-6 md:mb-10 tracking-tight break-words px-4">System Ready</div>
                <button onclick="nextPatient()" id="nextBtn" class="w-full md:w-auto px-8 md:px-12 py-4 md:py-6 bg-emerald-500 text-slate-900 rounded-2xl md:rounded-[2rem] font-black text-xl md:text-2xl shadow-xl hover:bg-emerald-400 transition transform hover:scale-105 active:scale-95 flex items-center justify-center gap-4 mx-auto uppercase">
                    Call Next <i data-lucide="arrow-right-circle" class="w-6 h-6 md:w-8 md:h-8"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                <div class="bg-white dark:bg-slate-900 p-6 md:p-8 rounded-[2rem] md:rounded-[3rem] border dark:border-slate-800 shadow-sm">
                    <h3 class="text-lg md:text-xl font-black mb-4 md:mb-6">Today's Statistics</h3>
                    <div class="grid grid-cols-3 gap-2 md:gap-4 text-center">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-2xl border border-blue-100 dark:border-blue-900"><p class="text-[9px] md:text-[10px] font-black text-blue-500 uppercase">Total</p><p id="statTotalToday" class="text-2xl md:text-4xl font-black mt-1">0</p></div>
                        <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-2xl border border-orange-100 dark:border-orange-900"><p class="text-[9px] md:text-[10px] font-black text-orange-500 uppercase">Wait</p><p id="statPendingToday" class="text-2xl md:text-4xl font-black mt-1">0</p></div>
                        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-2xl border border-green-100 dark:border-green-900"><p class="text-[9px] md:text-[10px] font-black text-green-500 uppercase">Done</p><p id="statDoneToday" class="text-2xl md:text-4xl font-black mt-1">0</p></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-6 md:p-8 rounded-[2rem] md:rounded-[3rem] border dark:border-slate-800 shadow-sm flex flex-col justify-center gap-4">
                    <button onclick="openHistory()" class="w-full h-16 md:h-20 bg-slate-900 text-white rounded-2xl md:rounded-[1.5rem] font-black text-base md:text-lg flex items-center justify-between px-6 md:px-8 hover:bg-slate-800 transition">
                        Full History & Reports <i data-lucide="file-bar-chart-2"></i>
                    </button>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="toggleTheme()" class="h-14 md:h-16 bg-slate-100 dark:bg-slate-800 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                            <i data-lucide="moon" class="w-5 h-5"></i> <span class="hidden md:inline">Theme</span>
                        </button>
                        <button onclick="logout()" class="h-14 md:h-16 bg-red-50 text-red-600 rounded-2xl font-bold flex items-center justify-center gap-2 border border-red-100 hover:bg-red-100 transition">
                            <i data-lucide="log-out" class="w-5 h-5"></i> <span class="hidden md:inline">Exit</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- HISTORY / REPORTS OVERLAY PAGE -->
    <div id="historyOverlay" class="report-overlay fixed inset-0 z-[200] bg-white dark:bg-slate-950 overflow-y-auto">
        <div class="max-w-7xl mx-auto p-4 md:p-10 space-y-6 md:space-y-10">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 border-b dark:border-slate-800 pb-6 md:pb-8">
                <h1 class="text-3xl md:text-4xl font-black tracking-tighter">Reports Center</h1>
                <button onclick="closeHistory()" class="p-4 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-red-50 hover:text-red-600 transition">
                    <i data-lucide="x" class="w-6 h-6 md:w-8 md:h-8"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-end">
                <div class="lg:col-span-6 flex flex-wrap gap-4 bg-slate-50 dark:bg-slate-900 p-6 rounded-3xl border dark:border-slate-800">
                    <div class="flex-1 min-w-[130px]"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">From</label><input type="date" id="histFrom" class="w-full h-12 px-4 rounded-xl border font-bold bg-white dark:bg-slate-800"></div>
                    <div class="flex-1 min-w-[130px]"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">To</label><input type="date" id="histTo" class="w-full h-12 px-4 rounded-xl border font-bold bg-white dark:bg-slate-800"></div>
                    <button onclick="fetchHistory()" class="h-12 px-8 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">Filter</button>
                </div>
                <div class="lg:col-span-6 flex gap-4">
                    <button onclick="downloadHistory()" class="flex-1 h-16 md:h-20 bg-emerald-600 text-white rounded-3xl font-black text-sm md:text-lg flex items-center justify-center gap-3 shadow-xl hover:bg-emerald-500 transition"><i data-lucide="download"></i> CSV Export</button>
                    <button onclick="securePurge()" class="flex-1 h-16 md:h-20 bg-red-100 text-red-600 rounded-3xl font-black text-sm md:text-lg flex items-center justify-center gap-3 border border-red-200 hover:bg-red-50 transition"><i data-lucide="trash-2"></i> Purge All</button>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-900 rounded-[2.5rem] border dark:border-slate-800 overflow-hidden shadow-2xl">
                <div class="px-6 md:px-8 py-5 border-b dark:border-slate-800 flex justify-between bg-slate-50 dark:bg-slate-800/50">
                    <span class="font-black text-sm md:text-base">Database (All Time)</span><span id="histCount" class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-bold">Total: 0</span>
                </div>
                <div class="overflow-x-auto w-full">
                    <table class="w-full text-left min-w-[700px]">
                        <tbody id="histTableBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://cnpytnxklswutujeitju.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNucHl0bnhrbHN3dXR1amVpdGp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDI2NjMsImV4cCI6MjA4NjkxODY2M30.jOb1bEOMLVZc-wZ6MsOzJ4eY7K7aByPabC-8I2wDlUo";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let session = JSON.parse(localStorage.getItem('docly_session')) || null;
        let realtimeSubscription;

        window.onload = () => {
            if (localStorage.getItem('docly_theme') === 'dark') document.documentElement.classList.add('dark');
            if (session) initApp();
            else document.getElementById('loginPage').classList.remove('hidden');
            lucide.createIcons();
        };

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('docly_theme', isDark ? 'dark' : 'light');
            lucide.createIcons();
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            let role = (u === 'recdemo' && p === '123') ? 'reception' : (u === 'docdemo' && p === '123') ? 'doctor' : '';
            if (role) {
                session = { role, name: u };
                localStorage.setItem('docly_session', JSON.stringify(session));
                document.getElementById('loginPage').classList.add('hidden'); // Immediate visual feedback
                initApp();
            } else alert('Access Denied');
        });

        function logout() { 
            if (realtimeSubscription) _supabase.removeChannel(realtimeSubscription);
            localStorage.removeItem('docly_session'); 
            location.reload(); 
        }

        async function initApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('userRoleDisplay').innerText = session.role;
            document.getElementById(session.role === 'reception' ? 'receptionSection' : 'doctorSection').classList.remove('hidden');

            await fetchData();
            setupRealtime();
        }

        function setupRealtime() {
            // FIX: Robust Real-time subscription
            if (realtimeSubscription) _supabase.removeChannel(realtimeSubscription);
            
            realtimeSubscription = _supabase
                .channel('public:patients')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'patients' }, (payload) => {
                    console.log('Realtime change received:', payload);
                    fetchData(); // Trigger UI update on any DB change
                })
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });
        }

        async function fetchData() {
            const { data, error } = await _supabase.from('patients').select('*').order('created_at', { ascending: true });
            if (!error) {
                allData = data || [];
                // Update UI based on active role
                if (!document.getElementById('receptionSection').classList.contains('hidden')) renderReception();
                if (!document.getElementById('doctorSection').classList.contains('hidden')) renderDoctor();
            } else {
                console.error("Fetch error:", error);
            }
        }

        function toggleUPI() { 
            const isUPI = document.getElementById('pPayment').value === 'UPI';
            document.getElementById('pTransaction').classList.toggle('hidden', !isUPI);
            if(isUPI) document.getElementById('pTransaction').focus();
        }

        document.getElementById('patientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const regBtn = document.getElementById('regBtn');
            const originalText = regBtn.innerText;
            regBtn.innerText = "Processing..."; regBtn.disabled = true;

            try {
                const today = new Date().toISOString().split('T')[0];
                
                // FIX: Get accurate count from DB to prevent duplicate tokens
                const { count, error: countError } = await _supabase
                    .from('patients')
                    .select('*', { count: 'exact', head: true })
                    .eq('visit_date', today);
                
                if (countError) throw countError;

                const newToken = (count || 0) + 1;

                const { error: insertError } = await _supabase.from('patients').insert([{
                    token: newToken, 
                    name: document.getElementById('pName').value, 
                    age: document.getElementById('pAge').value,
                    gender: document.getElementById('pGender').value, 
                    phone: document.getElementById('pPhone').value,
                    address: document.getElementById('pAddress').value, 
                    payment_method: document.getElementById('pPayment').value,
                    transaction_id: document.getElementById('pTransaction').value || 'N/A', 
                    visit_date: today, 
                    status: 'waiting'
                }]);

                if (insertError) throw insertError;

                // Immediate fetch to update UI without waiting for socket
                await fetchData(); 
                
                alert(`Patient Registered! Token #${newToken}`);
                e.target.reset(); 
                toggleUPI();

            } catch (err) {
                alert("Error: " + err.message);
                console.error(err);
            } finally {
                regBtn.innerText = originalText; regBtn.disabled = false;
            }
        });

        async function deletePatient(id) {
            if (confirm('Permanently delete this patient record?')) {
                await _supabase.from('patients').delete().eq('id', id);
                await fetchData(); // Immediate update
            }
        }

        function renderReception() {
            const today = new Date().toISOString().split('T')[0];
            const list = allData.filter(p => p.visit_date === today);
            
            document.getElementById('recWaiting').innerText = list.filter(p => p.status === 'waiting').length;
            document.getElementById('recDone').innerText = list.filter(p => p.status === 'completed').length;
            document.getElementById('recTotal').innerText = list.length;
            
            const now = list.find(p => p.status === 'calling');
            document.getElementById('recNowCalling').innerText = now ? `#${now.token}` : "--";

            const tableBody = document.getElementById('recTableBody');
            tableBody.innerHTML = list.slice().reverse().map(p => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition group">
                    <td class="px-6 md:px-8 py-5 font-black text-2xl tracking-tighter">#${p.token}</td>
                    <td class="px-6 md:px-8 py-5">
                        <div class="font-extrabold text-sm md:text-base">${p.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">${p.age}Y â€¢ ${p.gender}</div>
                    </td>
                    <td class="px-6 md:px-8 py-5">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase whitespace-nowrap 
                            ${p.status === 'waiting' ? 'bg-orange-100 text-orange-600' : 
                              p.status === 'calling' ? 'bg-blue-600 text-white animate-pulse' : 
                              'bg-emerald-100 text-emerald-600'}">
                            ${p.status}
                        </span>
                    </td>
                    <td class="px-6 md:px-8 py-5 text-right">
                        <button onclick="deletePatient('${p.id}')" class="text-slate-300 hover:text-red-500 transition p-2">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function nextPatient() {
            const btn = document.getElementById('nextBtn');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const today = new Date().toISOString().split('T')[0];
                const list = allData.filter(p => p.visit_date === today);
                
                const current = list.find(p => p.status === 'calling');
                const next = list.filter(p => p.status === 'waiting').sort((a,b) => a.token - b.token)[0]; // Sort by token to ensure order

                // Update DB sequentially
                if (current) await _supabase.from('patients').update({ status: 'completed' }).eq('id', current.id);
                
                if (next) {
                    await _supabase.from('patients').update({ status: 'calling' }).eq('id', next.id);
                } else {
                    if(!current) alert("No patients in waiting list!");
                }

                await fetchData(); // Immediate update for the doctor
            } catch (err) {
                console.error("Next patient error", err);
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function renderDoctor() {
            const today = new Date().toISOString().split('T')[0];
            const list = allData.filter(p => p.visit_date === today);
            
            const active = list.find(p => p.status === 'calling');
            
            // UI Updates
            const tokenDisplay = document.getElementById('docTokenDisplay');
            const infoDisplay = document.getElementById('docPatientInfo');

            if (active) {
                tokenDisplay.innerText = `#${active.token}`;
                infoDisplay.innerText = `${active.name} (${active.age}y / ${active.gender})`;
                tokenDisplay.classList.remove('text-slate-700');
                tokenDisplay.classList.add('text-white', 'glow-text');
            } else {
                tokenDisplay.innerText = "--";
                infoDisplay.innerText = "Waiting for next patient...";
                tokenDisplay.classList.remove('text-white', 'glow-text');
                tokenDisplay.classList.add('text-slate-700');
            }

            document.getElementById('statTotalToday').innerText = list.length;
            document.getElementById('statPendingToday').innerText = list.filter(p => p.status === 'waiting').length;
            document.getElementById('statDoneToday').innerText = list.filter(p => p.status === 'completed').length;
        }

        function openHistory() { document.getElementById('historyOverlay').classList.add('active'); fetchHistory(); }
        function closeHistory() { document.getElementById('historyOverlay').classList.remove('active'); }

        async function fetchHistory() {
            const from = document.getElementById('histFrom').value;
            const to = document.getElementById('histTo').value;
            let data = [...allData];
            
            if (from && to) data = data.filter(p => p.visit_date >= from && p.visit_date <= to);
            
            document.getElementById('histCount').innerText = "Total: " + data.length;
            document.getElementById('histTableBody').innerHTML = data.slice().reverse().map(p => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <td class="px-6 md:px-8 py-4 text-xs font-bold text-slate-500 whitespace-nowrap">${p.visit_date}</td>
                    <td class="px-6 md:px-8 py-4 font-black">#${p.token}</td>
                    <td class="px-6 md:px-8 py-4 font-bold whitespace-nowrap">${p.name}</td>
                    <td class="px-6 md:px-8 py-4 text-sm whitespace-nowrap">${p.age} / ${p.gender}</td>
                    <td class="px-6 md:px-8 py-4 text-sm whitespace-nowrap">${p.phone}</td>
                    <td class="px-6 md:px-8 py-4 uppercase text-[10px] font-black tracking-wider text-slate-400">${p.status}</td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function downloadHistory() {
            const { data, error } = await _supabase.from('patients').select('*').csv();
            if (error) return alert('Export Failed');
            const blob = new Blob([data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Docly_Clinic_Backup_${new Date().toISOString().slice(0,10)}.csv`; a.click();
        }

        async function securePurge() {
            if (prompt("Enter Login Password to Reset All Data:") === "123") {
                if (confirm("WARNING: This will delete ALL patient history permanently. Continue?")) {
                    const { error } = await _supabase.from('patients').delete().neq('id', '00000000-0000-0000-0000-000000000000');
                    if(error) alert("Error clearing DB");
                    else {
                        alert("Memory Cleared."); 
                        closeHistory(); 
                        await fetchData();
                    }
                }
            } else alert("Incorrect Password.");
        }
    </script>
</body>

</html>
